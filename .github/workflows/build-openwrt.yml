name: Build OpenWrt for Z8102AX-V2

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      target_device:
        description: 'Target device profile'
        required: true
        default: 'ZBT-Z8102AX-V2-emmc' # ğŸ‘‰ ç¡®ä¿è¿™ä¸ä½ çš„è®¾å¤‡æ ‡è¯†ç¬¦ä¸€è‡´
        type: string

env:
  # ğŸ‘‰ éœ€è¦ä¿®æ”¹ï¼šä½¿ç”¨OpenWrtå®˜æ–¹ç¨³å®šç‰ˆæºç ä»“åº“å’Œåˆ†æ”¯
  REPO_URL: "https://github.com/openwrt/openwrt"
  REPO_BRANCH: "v24.10.4" # å»ºè®®ä½¿ç”¨ç¨³å®šç‰ˆï¼Œå¦‚ v23.05.3

  # ğŸ‘‰ éœ€è¦ä¿®æ”¹ï¼šä½ çš„DTSæ–‡ä»¶åï¼ˆä¸å«è·¯å¾„å’Œåç¼€ï¼‰
  YOUR_DTS_BASENAME: "mt7981b-zbtlink-zbt-z8102ax-v2-emmc"
  # ä½ çš„è®¾å¤‡æ ‡è¯†ç¬¦ï¼Œåº”ä¸ target/linux/mediatek/image/filogic.mk ä¸­å®šä¹‰çš„ä¸€è‡´
  DEFAULT_TARGET_DEVICE: "zbtlink_zbt-z8102ax-v2-emmc"
  MAKE_JOBS: 1 # ä½¿ç”¨å•æ ¸ç¼–è¯‘ï¼Œé¿å…å†…å­˜å’Œç£ç›˜ç©ºé—´é—®é¢˜

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 350

    steps:
    # 1. æ£€å‡ºå®˜æ–¹ OpenWrt æºç 
    - name: Checkout OpenWrt Source
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ env.REPO_BRANCH }}
        path: openwrt_source # æºç æ”¾åœ¨æ­¤ç›®å½•

    # 2. ä»æœ¬ä»“åº“å¤åˆ¶ä½ ä¿®æ”¹å¥½çš„DTSæ–‡ä»¶åˆ°OpenWrtæºç ä¸­
    - name: Copy Custom DTS File
      run: |
        # å°†ä½ ä»“åº“é‡Œå·²æœ‰çš„DTSæ–‡ä»¶å¤åˆ¶åˆ°OpenWrtæºç çš„æ­£ç¡®ä½ç½®
        # å‡è®¾ä½ çš„DTSæ–‡ä»¶åœ¨ä»“åº“æ ¹ç›®å½•çš„ `dts/` æ–‡ä»¶å¤¹ä¸‹ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´æºè·¯å¾„
        cp ./dts/${{ env.YOUR_DTS_BASENAME }}.dts ./openwrt_source/target/linux/mediatek/dts/
        echo "DTSæ–‡ä»¶å¤åˆ¶å®Œæˆã€‚"

    # 3. å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆåŸºäºOpenWrtå®˜æ–¹è¦æ±‚ï¼‰
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev file wget
        # é¢å¤–å®‰è£…å¯èƒ½éœ€è¦çš„32ä½åº“ï¼Œé˜²æ­¢flockç­‰å·¥å…·ç¼–è¯‘å¤±è´¥
        sudo apt-get install -y libc6-dev-i386

    # 4. è¿›å…¥ç›®å½•ï¼Œæ›´æ–°feeds
    - name: Update Feeds
      run: |
        cd openwrt_source
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 5. åº”ç”¨é»˜è®¤é…ç½®å¹¶æŒ‡å®šä½ çš„è®¾å¤‡
    - name: Configure for Target Device
      run: |
        cd openwrt_source
        make defconfig
        # å°†ä½ çš„è®¾å¤‡è®¾ç½®ä¸ºç¼–è¯‘ç›®æ ‡
        echo "CONFIG_TARGET_mediatek=y" >> .config
        echo "CONFIG_TARGET_mediatek_mt7981=y" >> .config
        echo "CONFIG_TARGET_mediatek_mt7981_DEVICE_${{ github.event.inputs.target_device || env.DEFAULT_TARGET_DEVICE }}=y" >> .config
        make oldconfig

    # 6. ä¸‹è½½ç¼–è¯‘æ‰€éœ€çš„å·¥å…·å’Œè½¯ä»¶åŒ…
    - name: Download Dependencies
      run: |
        cd openwrt_source
        make -j${{ env.MAKE_JOBS }} download

    # 7. æ¸…ç†ç©ºé—´ï¼ˆå…³é”®ï¼Œé¿å…ç£ç›˜ç©ºé—´ä¸è¶³ï¼‰
    - name: Cleanup Space Before Build
      run: |
        cd openwrt_source
        echo "æ¸…ç†ç¼–è¯‘ç¼“å­˜ä»¥èŠ‚çœç©ºé—´..."
        rm -rf ./build_dir/host/* ./staging_dir/host/*
        df -h

    # 8. å¼€å§‹ç¼–è¯‘å›ºä»¶
    - name: Compile Firmware
      run: |
        cd openwrt_source
        make -j${{ env.MAKE_JOBS }} V=s

    # 9. ä¸Šä¼ ç¼–è¯‘å¥½çš„å›ºä»¶
    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-Firmware-${{ github.event.inputs.target_device || env.DEFAULT_TARGET_DEVICE }}
        path: |
          openwrt_source/bin/targets/**/*.bin
        retention-days: 3
