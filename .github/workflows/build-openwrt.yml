name: Build OpenWrt for Z8102AX-V2

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
    inputs:
      target_device:
        description: 'ç›®æ ‡è®¾å¤‡æ ‡è¯†ç¬¦ (éœ€ä¸filogic.mkä¸­å®šä¹‰ä¸€è‡´)'
        required: true
        default: 'zbtlink_zbt-z8102ax-v2-emmc' # ğŸ‘ˆ è¯·åŠ¡å¿…ç¡®è®¤æ­¤åç§°
        type: string

env:
  # æºç é…ç½®
  OPENWRT_REPO: "openwrt/openwrt"
  OPENWRT_BRANCH: "v24.10.4" # ä½ æŒ‡å®šçš„ç‰ˆæœ¬
  CUSTOM_REPO: "xyzy12345/immortalwrt" # ä½ çš„DTSä»“åº“
  # è®¾å¤‡é…ç½®
  DTS_FILENAME: "mt7981b-zbtlink-zbt-z8102ax-v2-emmc.dts"
  # ç¼–è¯‘é…ç½®
  MAKE_JOBS: 1 # å•æ ¸ç¼–è¯‘ï¼Œæé«˜ç¨³å®šæ€§

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 350 # æ¥è¿‘6å°æ—¶ä¸Šé™

    steps:
    # æ­¥éª¤ 1: æ£€å‡º OpenWrt å®˜æ–¹æºç 
    - name: Checkout OpenWrt Source
      uses: actions/checkout@v4
      with:
        repository: ${{ env.OPENWRT_REPO }}
        ref: ${{ env.OPENWRT_BRANCH }}
        path: openwrt_source

    # æ­¥éª¤ 2: æ£€å‡ºä½ è‡ªå®šä¹‰çš„ ImmortalWrt ä»“åº“ (åŒ…å«DTS)
    - name: Checkout Custom Repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.CUSTOM_REPO }}
        path: custom_repo

    # æ­¥éª¤ 3: å¤åˆ¶è®¾å¤‡æ”¯æŒæ–‡ä»¶ (DTS å’Œ .mk å®šä¹‰æ–‡ä»¶)
    - name: Copy Device Support Files
      run: |
        echo "å¤åˆ¶è‡ªå®šä¹‰è®¾å¤‡æ–‡ä»¶..."
        # 3.1 å¤åˆ¶ DTS æ–‡ä»¶
        cp ./custom_repo/target/linux/mediatek/dts/${{ env.DTS_FILENAME }} ./openwrt_source/target/linux/mediatek/dts/
        echo "âœ… DTS æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
        # 3.2 å¤åˆ¶è®¾å¤‡å®šä¹‰æ–‡ä»¶ (å…³é”®æ­¥éª¤)
        # æ³¨æ„: OpenWrt æ–°ç‰ˆå¯èƒ½ä½¿ç”¨ filogic.mkï¼Œè¿™é‡Œå¤åˆ¶ä½ ä¿®æ”¹è¿‡çš„ç‰ˆæœ¬
        cp ./custom_repo/target/linux/mediatek/image/mt7981.mk ./openwrt_source/target/linux/mediatek/image/
        echo "âœ… è®¾å¤‡å®šä¹‰æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
        # 3.3 éªŒè¯
        ls -lh ./openwrt_source/target/linux/mediatek/dts/*z8102ax*.dts

    # æ­¥éª¤ 4: å®‰è£…å®Œæ•´çš„ç¼–è¯‘ä¾èµ–
    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          g++-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          quilt \
          cpio
        # é˜²æ­¢ 32 ä½å·¥å…·é“¾ç¼–è¯‘å¤±è´¥çš„å…³é”®åº“
        sudo apt-get install -y libc6-dev-i386 lib32stdc++6

    # æ­¥éª¤ 5: æ›´æ–°å’Œå®‰è£…è½¯ä»¶åŒ…æº (feeds)
    - name: Update and Install Feeds
      run: |
        cd openwrt_source
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # æ­¥éª¤ 6: é…ç½®ç›®æ ‡è®¾å¤‡ (å…³é”®ä¸”æ˜“é”™æ­¥éª¤)
    - name: Configure Target Device
      run: |
        cd openwrt_source
        # 6.1 ç”Ÿæˆé»˜è®¤é…ç½®æ¡†æ¶
        make defconfig
        # 6.2 åº”ç”¨ç›®æ ‡é…ç½® (è¯·æ ¹æ®OpenWrtå®é™…ç»“æ„è°ƒæ•´)
        # å¯¹äº v24.10.4ï¼ŒMT7981 é€šå¸¸åœ¨ filogic å­ç›®æ ‡ä¸‹
        echo "CONFIG_TARGET_mediatek=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
        # æ­¤è¡Œå¿…é¡»ä¸ filogic.mk ä¸­çš„è®¾å¤‡æ ‡è¯†ç¬¦ä¸¥æ ¼åŒ¹é…
        echo "CONFIG_TARGET_DEVICE_mediatek_filogic_${{ github.event.inputs.target_device }}=y" >> .config
        # 6.3 åº”ç”¨é…ç½®
        make oldconfig

    # æ­¥éª¤ 7: ä¸‹è½½æ‰€æœ‰ä¾èµ–
    - name: Download Dependencies
      run: |
        cd openwrt_source
        make -j${{ env.MAKE_JOBS }} download

    # æ­¥éª¤ 8: æ¸…ç†ç©ºé—´ (é¿å…ç£ç›˜ç©ºé—´ä¸è¶³)
    - name: Clean Up Disk Space
      run: |
        cd openwrt_source
        echo "æ¸…ç†ä¸»æœºå·¥å…·æ„å»ºç¼“å­˜..."
        rm -rf ./build_dir/host/*
        echo "å½“å‰ç£ç›˜ç©ºé—´:"
        df -h

    # æ­¥éª¤ 9: ç¼–è¯‘å›ºä»¶ (æ ¸å¿ƒæ­¥éª¤)
    - name: Compile Firmware
      run: |
        cd openwrt_source
        make -j${{ env.MAKE_JOBS }} V=s 2>&1 | tee compile.log
        # ç¼–è¯‘åæ£€æŸ¥
        echo "ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºç›®å½•:"
        find ./bin/targets -name "*.bin" -type f | head -5

    # æ­¥éª¤ 10: ä¸Šä¼ ç”Ÿæˆçš„å›ºä»¶
    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-Firmware-${{ github.event.inputs.target_device }}
        path: |
          openwrt_source/bin/targets/**/*.bin
          openwrt_source/compile.log
        retention-days: 7
