name: Build OpenWrt for Z8102AX-V2

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      target_device:
        description: 'Target device profile'
        required: true
        default: 'ZBT-Z8102AX-V2-emmc' # ğŸ‘‰ è¯·ç¡®è®¤æ­¤æ ‡è¯†ç¬¦åœ¨OpenWrtä¸­å­˜åœ¨
        type: string

env:
  REPO_URL: "https://github.com/openwrt/openwrt"
  REPO_BRANCH: "v24.10.4" # ä½ å·²ä¿®æ”¹ä¸º24.10.4
  YOUR_DTS_BASENAME: "mt7981b-zbtlink-zbt-z8102ax-v2-emmc"
  # âš ï¸ é‡è¦ï¼šç¡®è®¤OpenWrtä¸­ä½¿ç”¨çš„æ ‡è¯†ç¬¦
  DEFAULT_TARGET_DEVICE: "zbtlink_zbt-z8102ax-v2-emmc"
  MAKE_JOBS: 1

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 350

    steps:
    # 1. æ£€å‡ºå®˜æ–¹ OpenWrt æºç 
    - name: Checkout OpenWrt Source
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: ${{ env.REPO_BRANCH }}
        path: openwrt_source

    # 2. å¤åˆ¶è‡ªå®šä¹‰è®¾å¤‡æ–‡ä»¶ (å…³é”®æ­¥éª¤)
    - name: Copy Custom Device Files
      run: |
        echo "æ­£åœ¨å¤åˆ¶è‡ªå®šä¹‰è®¾å¤‡æ–‡ä»¶..."
        
        # 2.1 å¤åˆ¶DTSæ–‡ä»¶
        cp ./target/linux/mediatek/dts/mt7981b-zbtlink-zbt-z8102ax-v2-emmc.dts ./openwrt_source/target/linux/mediatek/dts/
        echo "DTSæ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
        # 2.2 (å…³é”®) å¤åˆ¶è®¾å¤‡å®šä¹‰æ–‡ä»¶
        # OpenWrt v24.10.4 ä¸­ï¼ŒMT7981è®¾å¤‡çš„å®šä¹‰å¯èƒ½åœ¨ `filogic.mk` è€Œä¸æ˜¯ `mt7981.mk`
        # è¯·æ ¹æ®OpenWrtæºç çš„å®é™…ç»“æ„è°ƒæ•´ç›®æ ‡è·¯å¾„å’Œæ–‡ä»¶å
        cp ./target/linux/mediatek/image/mt7981.mk ./openwrt_source/target/linux/mediatek/image/
        echo "è®¾å¤‡å®šä¹‰æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        
        # 2.3 éªŒè¯
        ls -la ./openwrt_source/target/linux/mediatek/dts/*z8102ax*
        ls -la ./openwrt_source/target/linux/mediatek/image/

    # 3. å®‰è£…ç¼–è¯‘ä¾èµ–
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev file wget
        sudo apt-get install -y libc6-dev-i386

    # 4. è¿›å…¥ç›®å½•ï¼Œæ›´æ–°feeds
    - name: Update Feeds
      run: |
        cd openwrt_source
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 5. åº”ç”¨é…ç½®
    - name: Configure for Target Device
      run: |
        cd openwrt_source
        make defconfig
        # é…ç½®å‘½ä»¤éœ€ä¸OpenWrtçš„Kconfigè¯­æ³•åŒ¹é…
        # å¦‚æœè®¾å¤‡æ ‡è¯†ç¬¦ä¸ç¡®å®šï¼Œå¯ä»¥å…ˆå°è¯•ä¸æŒ‡å®šï¼Œåœ¨åç»­æ­¥éª¤ä¸­é€šè¿‡menuconfigé€‰æ‹©
        echo "CONFIG_TARGET_mediatek=y" >> .config
        echo "CONFIG_TARGET_mediatek_filogic=y" >> .config
        # ä»¥ä¸‹è¿™è¡Œæ˜¯å…³é”®ï¼Œå¦‚æœè®¾å¤‡æ ‡è¯†ç¬¦é”™è¯¯ä¼šå¯¼è‡´ç¼–è¯‘æ‰¾ä¸åˆ°ç›®æ ‡
        echo "CONFIG_TARGET_DEVICE_mediatek_filogic_${{ github.event.inputs.target_device || env.DEFAULT_TARGET_DEVICE }}=y" >> .config
        make oldconfig

    # 6. ä¸‹è½½ä¾èµ–
    - name: Download Dependencies
      run: |
        cd openwrt_source
        make -j${{ env.MAKE_JOBS }} download

    # 7. æ¸…ç†ç©ºé—´
    - name: Cleanup Space Before Build
      run: |
        cd openwrt_source
        echo "æ¸…ç†ç¼–è¯‘ç¼“å­˜..."
        rm -rf ./build_dir/host/* ./staging_dir/host/*
        df -h

    # 8. ç¼–è¯‘å›ºä»¶
    - name: Compile Firmware
      run: |
        cd openwrt_source
        make -j${{ env.MAKE_JOBS }} V=s

    # 9. ä¸Šä¼ å›ºä»¶
    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-Firmware-${{ github.event.inputs.target_device || env.DEFAULT_TARGET_DEVICE }}
        path: |
          openwrt_source/bin/targets/**/*.bin
        retention-days: 3
