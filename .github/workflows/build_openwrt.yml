name: Build ImmortalWrt

# 控制工作流何时运行
on:
  # 允许在 GitHub 页面上手动触发
  workflow_dispatch:
    inputs:
      target_device:
        description: 'Target device profile (e.g., z8102ax-v2-emmc)'
        required: true
        default: 'z8102ax-v2-emmc'
        type: string

  # 你也可以启用推送代码时自动编译
  # push:
  #   branches: [ "main" ]
  #   paths:
  #     - 'target/linux/**'
  #     - '.github/workflows/**'

# 全局环境变量
env:
  # ============ 【必须修改】 你的仓库信息 ============
  REPO_URL: "https://github.com/xyzy12345/immortalwrt"
  REPO_BRANCH: "main"
  # ============ 【必须修改】 你的目标设备 ============
  DEFAULT_TARGET_DEVICE: "z8102ax-v2-emmc"
  # ==============================================

  # 高级选项
  FEEDS_CONF: "feeds.conf.default"
  # 设置编译线程数
  MAKE_JOBS: 2

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 350

    steps:
    # 步骤 1: 检出源码
    - name: Checkout ImmortalWrt source
      uses: actions/checkout@v4
      with:
        repository: ${{ github.repository }}
        ref: ${{ github.ref }}
        path: openwrt

    # 步骤 2: 安装编译依赖
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          gawk \
          gcc-multilib \
          flex \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          quilt
        # 用于解决32位工具链编译问题
        sudo apt-get install -y libc6-dev-i386 g++-multilib lib32stdc++6 lib32z1-dev

    # 步骤 3: 更新和安装 feeds
    - name: Update and install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # 步骤 4: 应用设备配置
    - name: Apply configuration for target device
      run: |
        cd openwrt
        # 获取目标设备名称（手动输入或使用默认值）
        TARGET_DEVICE="${{ github.event.inputs.target_device || env.DEFAULT_TARGET_DEVICE }}"
        
        # 方法1: 使用 defconfig 并设置配置
        make defconfig
        
        # 对于 mt7981 设备，通常需要设置这两个配置
        echo "CONFIG_TARGET_mediatek=y" >> .config
        echo "CONFIG_TARGET_mediatek_mt7981=y" >> .config
        
        # 根据具体设备设置profile（需要查看你的设备定义）
        # 假设你的设备在 target/linux/mediatek/mt7981/base-files/etc/board.d/01_leds
        # 通常格式是 CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_$DEVICE=y
        echo "CONFIG_TARGET_DEVICE_mediatek_mt7981_DEVICE_$TARGET_DEVICE=y" >> .config
        
        # 运行 oldconfig 处理依赖
        make oldconfig
        
        # 显示配置摘要
        echo "=== 当前配置摘要 ==="
        grep "CONFIG_TARGET\|CONFIG_DEVICE" .config | head -20

    # 步骤 5: 下载依赖和工具链
    - name: Download dependencies and build tools
      run: |
        cd openwrt
        echo "=== 开始下载依赖 ==="
        make -j${{ env.MAKE_JOBS }} download V=s
        
        echo "=== 开始构建宿主工具链 ==="
        make -j${{ env.MAKE_JOBS }} tools/install V=s
        
        echo "=== 宿主工具链构建完成 ==="
        # 验证工具链
        if [ -f "./staging_dir/host/bin/gcc" ]; then
          echo "✓ 宿主工具链构建成功"
        else
          echo "✗ 宿主工具链构建失败"
          exit 1
        fi

    # 步骤 6: 清理空间（可选，空间不足时启用）
    - name: Cleanup space if needed
      run: |
        cd openwrt
        echo "=== 当前磁盘空间 ==="
        df -h
        
        # 如果空间紧张，可以删除一些缓存
        # 注意：这会延长后续编译时间，因为需要重新下载
        AVAILABLE_SPACE=$(df . | tail -1 | awk '{print $4}')
        if [ "$AVAILABLE_SPACE" -lt 10000000 ]; then  # 小于10GB
          echo "磁盘空间不足，清理部分缓存..."
          # 只清理构建缓存，保留下载的源码包
          rm -rf ./build_dir/host/* ./build_dir/toolchain-*/*
        else
          echo "磁盘空间充足，跳过清理"
        fi

    # 步骤 7: 编译固件
    - name: Compile firmware
      run: |
        cd openwrt
        echo "=== 开始编译固件 ==="
        # 使用 V=s 显示详细输出，便于调试
        # 首次编译建议保留 V=s，稳定后可改为 V=sc 或去掉
        make -j${{ env.MAKE_JOBS }} V=s 2>&1 | tee build.log
        
        # 检查编译结果
        if [ -f "bin/targets/mediatek/mt7981/*.bin" ]; then
          echo "✓ 固件编译成功"
          ls -la bin/targets/mediatek/mt7981/*.bin
        else
          echo "✗ 固件编译失败"
          # 检查错误日志
          tail -100 build.log
          exit 1
        fi

    # 步骤 8: 上传固件
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ImmortalWrt-Firmware-${{ github.event.inputs.target_device || env.DEFAULT_TARGET_DEVICE }}
        path: |
          openwrt/bin/targets/**/*.bin
          openwrt/bin/targets/**/*.manifest
          openwrt/build.log
        retention-days: 2
